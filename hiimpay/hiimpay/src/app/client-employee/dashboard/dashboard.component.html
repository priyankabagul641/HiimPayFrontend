<div class="coupon-portal">
  <div class="ambient-bg"></div>

  <section class="screen app-screen">
    <aside class="left-nav" [class.collapsed]="!showSidebar">
      <div class="nav-brand">
        <img src="assets/images/navexwise.jpeg" alt="HiimPay" />
        <div *ngIf="showSidebar">
          <strong>HiimPay</strong>
          <span>Coupon Portal</span>
        </div>
      </div>
      <button
        [class.active]="activeScreen === 'home'"
        (click)="navigate('home')"
        title="Dashboard"
        data-short="DB"
      >
        <mat-icon>dashboard</mat-icon>
        <span class="label">Dashboard</span>
      </button>
      <button
        [class.active]="activeScreen === 'browse'"
        (click)="navigate('browse')"
        title="Browse Coupons"
        data-short="BR"
      >
        <mat-icon>confirmation_number</mat-icon>
        <span class="label">Browse Coupons</span>
      </button>
      <!-- <button
        [class.active]="activeScreen === 'categories'"
        (click)="navigate('categories')"
        title="Categories"
        data-short="CT"
      >
        <mat-icon>grid_view</mat-icon>
        <span class="label">Categories</span>
      </button> -->
      <button
        [class.active]="activeScreen === 'my-coupons'"
        (click)="navigate('my-coupons')"
        title="My Coupons"
        data-short="MC"
      >
        <mat-icon>sell</mat-icon>
        <span class="label">My Coupons</span>
      </button>
      <button
        [class.active]="activeScreen === 'wallet'"
        (click)="navigate('wallet')"
        title="Wallet"
        data-short="WL"
      >
        <mat-icon>account_balance_wallet</mat-icon>
        <span class="label">Wallet</span>
      </button>
    </aside>

    <main class="main-content">
      <header class="screen-header">
        <div class="header-actions">
          <button class="icon-action" type="button" (click)="toggleSidebar()">☰</button>
          <button class="icon-action" type="button" *ngIf="activeScreen !== 'home'" (click)="goBack()">← Back</button>
        </div>
        <h2 *ngIf="activeScreen === 'home'">Hello, {{ loggedInUserName }}</h2>
        <h2 *ngIf="activeScreen === 'browse'">Browse Coupons</h2>
        <h2 *ngIf="activeScreen === 'categories'">Categories</h2>
        <h2 *ngIf="activeScreen === 'details'">Coupon Details</h2>
        <h2 *ngIf="activeScreen === 'my-coupons'">My Coupons</h2>
        <h2 *ngIf="activeScreen === 'wallet'">Wallet & Savings</h2>
        <div class="header-actions right">
          <button class="icon-only" type="button" (click)="toggleFaqPanel()" title="FAQ" aria-label="FAQ">
            <mat-icon>help_outline</mat-icon>
          </button>
          <button class="icon-only bell" type="button" (click)="toggleNotifications()" title="Notifications" aria-label="Notifications">
            <mat-icon>notifications_none</mat-icon>
            <span *ngIf="unreadCount > 0">{{ unreadCount }}</span>
          </button>
          <button class="avatar-btn" [matMenuTriggerFor]="profileMenu" type="button" title="Profile" aria-label="Profile">
            <img src="assets/images/navexwise.jpeg" alt="profile" />
          </button>
        </div>
      </header>
      <mat-menu #profileMenu="matMenu">
        <button mat-menu-item (click)="openProfile()">
          <mat-icon>person</mat-icon>
          <span>Profile</span>
        </button>
        <button mat-menu-item (click)="logout()">
          <mat-icon>logout</mat-icon>
          <span>Logout</span>
        </button>
      </mat-menu>

      <section class="hero-banner" *ngIf="activeScreen === 'home'">
        <div class="hero-copy">
          <p class="kicker">Employee Benefit Campaign</p>
          <h3>Save more with curated lifestyle offers every week</h3>
          <p>Track your redemptions, balances, and savings performance from one dashboard.</p>
          <button class="hero-cta" (click)="navigate('browse')">Explore Offers</button>
        </div>
        <div class="hero-visual">
          <div class="hero-icon">%</div>
        </div>
      </section>

      <section class="floating-panel" *ngIf="showNotificationPanel">
        <h4>Notifications</h4>
        <div class="notification-item" *ngFor="let item of notifications">
          <p>{{ item.message }}</p>
          <small>{{ item.time }}</small>
        </div>
      </section>

      <section class="floating-panel" *ngIf="showFaqPanel">
        <h4>Frequently Asked Questions</h4>
        <div class="faq-item" *ngFor="let faq of faqs; let i = index" [class.open]="faqOpenIndex === i">
          <button class="faq-toggle" type="button" (click)="toggleFaqItem(i)">
            <span class="q">{{ faq.question }}</span>
            <span class="expand">{{ faqOpenIndex === i ? '−' : '+' }}</span>
          </button>
          <p class="a" *ngIf="faqOpenIndex === i">{{ faq.answer }}</p>
        </div>
      </section>

      <div class="content-stack">
        <ng-container *ngIf="activeScreen === 'home'">
          <div class="metrics-grid">
            <article class="metric-card wallet">
              <div class="metric-top">
                <span class="metric-icon"><mat-icon>account_balance_wallet</mat-icon></span>
                <span class="metric-trend up">+8%</span>
              </div>
              <p>Wallet Balance</p>
              <h3>₹{{ walletBalance }}</h3>
            </article>
          
          </div>

          <div class="quick-actions">
            <article class="qa-tile" *ngFor="let item of quickActions">
              <mat-icon class="qa-icon">{{ item.icon }}</mat-icon>
              <p>{{ item.title }}</p>
              <small>{{ item.description }}</small>
              <button (click)="onQuickAction(item.action)">Open</button>
            </article>
          </div>

          <div class="carousel-title">Featured Offers</div>
          <div class="featured-strip">
            <article class="featured-card" *ngFor="let offer of featuredOffers">
              <span class="badge">{{ offer.discountPercent > 0 ? offer.discountPercent + '% OFF' : 'Offer' }}</span>
              <img [src]="offer.image" alt="{{ offer.brand }}" class="offer-img" />
              <div class="featured-head">
                <span class="featured-logo" [style.background]="offer.brandColor">{{ offer.brandLogo }}</span>
                <h4>{{ offer.brand }}</h4>
              </div>
              <p>{{ offer.title }}</p>
              <small>Expires {{ offer.expiryDate | date: 'd MMM yyyy' }}</small>
              <button class="text-btn" (click)="showDetails(offer.id)">View</button>
            </article>
          </div>
        </ng-container>

        <ng-container *ngIf="activeScreen === 'browse'">
          <!-- <div class="search-bar-wr ap">
            <input type="text" [(ngModel)]="searchTerm" placeholder="Search by brand or offer" />
          </div> -->
             <div class="category-tab-strip">
            <button
              class="category-tab"
              *ngFor="let category of filteredCategories"
              [class.active]="selectedCategoryView === category.label"
              (click)="selectCategoryCard(category.label)"
            >
              <mat-icon>{{ category.icon }}</mat-icon>
              <span>{{ category.label }}</span>
            </button>
          </div>
          <div class="chips-wrap">
            
            <select [(ngModel)]="selectedBrand">
              <option value="All">Brand</option>
              <option *ngFor="let brand of uniqueBrands" [value]="brand">{{ brand }}</option>
            </select>
            <select [(ngModel)]="selectedDiscountType">
              <option value="All">Discount Type</option>
              <option value="Flat">Flat</option>
              <option value="Percentage">Percentage</option>
              <option value="Cashback">Cashback</option>
            </select>
          </div>

          <div class="coupon-grid">
            <article class="coupon-card" *ngFor="let offer of filteredOffers">
              <div class="coupon-top">
                <div class="brand-logo" [style.background]="offer.brandColor">{{ offer.brandLogo }}</div>
                <div>
                  <h4>{{ offer.brand }}</h4>
                  <p>{{ offer.title }}</p>
                </div>
                <span class="discount-pill">{{ offer.discountPercent > 0 ? offer.discountPercent + '% OFF' : 'Offer' }}</span>
              </div>
              <img [src]="offer.image" alt="{{ offer.brand }}" class="offer-img wide" />
              <div class="coupon-bottom">
                <small>Expires {{ offer.expiryDate | date: 'd MMM yyyy' }}</small>
                <span class="expiry-chip">{{ getDaysLeft(offer.expiryDate) }}d left</span>
                <div class="coupon-actions">
                  <button class="text-btn" (click)="showDetails(offer.id)">Details</button>
                  <button class="primary-btn" (click)="grabCoupon(offer.id)">Grab Coupon</button>
                </div>
              </div>
            </article>
          </div>
        </ng-container>

        <ng-container *ngIf="activeScreen === 'categories'">
          <div class="search-bar-wrap category-search-wrap">
            <input type="text" [(ngModel)]="categorySearchTerm" placeholder="Search category" />
          </div>
       
          <div class="carousel-title">Coupons in {{ selectedCategoryView }}</div>
          <article class="coupon-card" *ngFor="let offer of categoryOffers">
            <div class="coupon-top">
              <div class="brand-logo" [style.background]="offer.brandColor">{{ offer.brandLogo }}</div>
              <div>
                <h4>{{ offer.brand }}</h4>
                <p>{{ offer.title }}</p>
              </div>
              <span class="discount-pill">{{ offer.discountPercent > 0 ? offer.discountPercent + '% OFF' : 'Offer' }}</span>
            </div>
            <img [src]="offer.image" alt="{{ offer.brand }}" class="offer-img wide" />
            <div class="coupon-bottom">
              <small>Expires {{ offer.expiryDate | date: 'd MMM yyyy' }}</small>
              <span class="expiry-chip">{{ getDaysLeft(offer.expiryDate) }}d left</span>
              <div class="coupon-actions">
                <button class="text-btn" (click)="showDetails(offer.id)">Details</button>
                <button class="primary-btn" (click)="grabCoupon(offer.id)">Grab Coupon</button>
              </div>
            </div>
          </article>
        </ng-container>

        <ng-container *ngIf="activeScreen === 'details'">
          <article class="detail-card">
            <div class="detail-banner">
              <h3>{{ selectedOffer.brand }}</h3>
              <span>{{ selectedOffer.discountPercent > 0 ? selectedOffer.discountPercent + '% OFF' : 'Offer' }}</span>
            </div>
            <img [src]="selectedOffer.image" alt="{{ selectedOffer.brand }}" class="offer-img detail" />
            <h4>{{ selectedOffer.title }}</h4>
            <p>{{ selectedOffer.description }}</p>
            <p><strong>Expiry:</strong> {{ selectedOffer.expiryDate | date: 'd MMM yyyy' }}</p>
            <div class="detail-block">
              <h5>Terms & Conditions</h5>
              <p>{{ selectedOffer.terms }}</p>
            </div>
            <div class="detail-block">
              <h5>Redeem Steps</h5>
              <ul>
                <li *ngFor="let step of selectedOffer.redeemSteps">{{ step }}</li>
              </ul>
            </div>
            <button class="primary-btn" (click)="grabCoupon(selectedOffer.id)">Grab Coupon</button>
          </article>
        </ng-container>

        <ng-container *ngIf="activeScreen === 'my-coupons'">
           <div class="wallet-insight-grid">
              <article class="finance-card balance">
                <div class="finance-top">
                  <span class="finance-icon"><mat-icon>account_balance_wallet</mat-icon></span>
                  <span class="finance-trend">+10%</span>
                </div>
                <p>Purchased Coupons</p>
                <h3>{{ purchasedCount }}</h3>
              </article>
              <article class="finance-card total">
                <div class="finance-top">
                  <span class="finance-icon"><mat-icon>savings</mat-icon></span>
                  <span class="finance-trend">+9%</span>
                </div>
                <p>Assigned Coupons</p>
                <h3>{{ assignedCount }}</h3>
              </article>
              <article class="finance-card month">
                <div class="finance-top">
                  <span class="finance-icon"><mat-icon>show_chart</mat-icon></span>
                  <span class="finance-trend">+4%</span>
                </div>
                <p>Expired Coupons</p>
                <h3>{{ expiredCount }}</h3>
              </article>
            </div>
          <div class="tab-row">
            <button [class.active]="activeCouponTab === 'active'" (click)="selectCouponTab('active')">Active</button>
            <button [class.active]="activeCouponTab === 'used'" (click)="selectCouponTab('used')">Used</button>
            <button [class.active]="activeCouponTab === 'expired'" (click)="selectCouponTab('expired')">Expired</button>
          </div>

          <article class="owned-card" *ngFor="let coupon of filteredOwnedCoupons">
            <div class="owned-header">
              <h4>{{ coupon.brand }} - {{ coupon.title }}</h4>
              <span
                class="countdown"
                [class.warn]="getDaysLeft(coupon.expiresOn) <= 3 && coupon.status === 'active'"
                *ngIf="coupon.status === 'active'"
              >
                {{ getDaysLeft(coupon.expiresOn) }}d left
              </span>
            </div>
            <img
              [src]="coupon.imageUrl || (coupon.brand === 'Swiggy' ? 'assets/images/servey1.jfif' : coupon.brand === 'Myntra' ? 'assets/images/servey2.png' : 'assets/images/servey5.png')"
              alt="{{ coupon.brand }}"
              class="offer-img mini"
            />
            <div class="code-row">
              <code [class.copy-pulse]="copiedCouponCode === coupon.code">{{ coupon.code }}</code>
              <button class="secondary-btn" (click)="copyCode(coupon.code)" *ngIf="coupon.status === 'active'">Copy</button>
            </div>
            <p>{{ coupon.redeemInstruction }}</p>
          </article>
          <div *ngIf="userWalletCouponsLoading" style="text-align: center; padding: 20px;">
            <p>Loading your coupons...</p>
          </div>
          <div *ngIf="!userWalletCouponsLoading && filteredOwnedCoupons.length === 0" style="text-align: center; padding: 20px;">
            <p>No {{ activeCouponTab }} coupons found.</p>
          </div>
        </ng-container>
        <ng-container *ngIf="activeScreen === 'wallet'">
          <div class="wallet-toggle">
            <!-- <button [class.active]="walletView === 'coupon'" (click)="selectWalletView('coupon')">Coupon</button> -->
            <button [class.active]="walletView === 'amount'" (click)="selectWalletView('amount')">Amount</button>
          </div>

          <!-- <ng-container *ngIf="walletView === 'coupon'">
           

            <article class="ratio-card">
              <div class="ratio-head">
                <h4>Assigned vs Expired Ratio</h4>
                <span>This month purchased: {{ thisMonthPurchasedCount }}</span>
              </div>
              <div class="ratio-content">
                <div class="segmented-progress">
                  <div class="seg savings" [style.width.%]="assignedPercentage"></div>
                  <div class="seg spend" [style.width.%]="expiredPercentage"></div>
                </div>
                <div class="ratio-ring" [style.--ratio]="assignedPercentage">
                  <div class="ring-label">{{ assignedPercentage }}%</div>
                </div>
              </div>
              <div class="split-labels">
                <span><mat-icon>check_circle</mat-icon> Assigned {{ assignedPercentage }}%</span>
                <span><mat-icon>cancel</mat-icon> Expired {{ expiredPercentage }}%</span>
              </div>
            </article>

          
          </ng-container> -->

          <ng-container *ngIf="walletView === 'amount'">
            <div class="amount-summary-grid">
              <article class="mini-card">
                <mat-icon>account_balance_wallet</mat-icon>
                <p>Wallet Balance</p>
                <h5>₹{{ remainingAmount }}</h5>
              </article>
            </div>
            <article class="insight-card">
              <div class="insight-head">
                <h4>Transaction History</h4>
                <span>{{ walletTransactions.length }} transactions</span>
              </div>
              <div class="amount-transaction-list">
                <div class="amount-transaction-item" *ngFor="let tx of walletTransactions">
                  <div>
                    <p>{{ tx.description }}</p>
                    <small>{{ tx.date | date: 'd MMM yyyy' }}</small>
                  </div>
                  <strong [class.credit]="tx.type === 'credit'" [class.debit]="tx.type === 'debit'">
                    {{ tx.type === 'credit' ? '+' : '-' }}₹{{ tx.amount }}
                  </strong>
                </div>
              </div>
            </article>
          </ng-container>
        </ng-container>
      </div>
    </main>
  </section>

  <div class="toast" *ngIf="showToast">{{ toastMessage }}</div>

  <!-- Grab Coupon Dialog -->
  <div class="grab-overlay" *ngIf="showGrabDialog" (click)="closeGrabDialog()"></div>
  <div class="grab-dialog" *ngIf="showGrabDialog">

    <!-- CONFIRM SCREEN -->
    <ng-container *ngIf="grabDialogStep === 'confirm'">
      <div class="grab-dialog-header">
        <div class="grab-brand-logo" [style.background]="grabDialogOffer?.brandColor">
          {{ grabDialogOffer?.brandLogo }}
        </div>
        <div>
          <h4>{{ grabDialogOffer?.brand }}</h4>
          <p>{{ grabDialogOffer?.title }}</p>
        </div>
        <button class="grab-close-btn" type="button" (click)="closeGrabDialog()">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <div class="grab-offer-meta">
        <span class="grab-badge">{{ (grabDialogOffer?.discountPercent ?? 0) > 0 ? grabDialogOffer?.discountPercent + '% OFF' : 'Offer' }}</span>
        <span class="grab-range" *ngIf="grabDialogOffer?.minValue">
          ₹{{ grabDialogOffer?.minValue }} – ₹{{ grabDialogOffer?.maxValue }}
        </span>
        <span class="grab-expiry">
          <mat-icon>schedule</mat-icon> Expires {{ grabDialogOffer?.expiryDate | date:'d MMM yyyy' }}
        </span>
      </div>

      <div class="grab-form">
        <label class="grab-label">Amount (₹) <span class="req">*</span></label>
        <input
          type="number"
          class="grab-input"
          [(ngModel)]="grabAmount"
          [min]="grabDialogOffer?.minValue || 1"
          [max]="grabDialogOffer?.maxValue"
          placeholder="Enter amount"
          (ngModelChange)="validateGrabAmount()"
        />
        <small class="grab-hint" *ngIf="grabDialogOffer?.minValue && !grabAmountError">
          Min ₹{{ grabDialogOffer?.minValue }} &nbsp;·&nbsp; Max ₹{{ grabDialogOffer?.maxValue }}
        </small>
        <small class="grab-amount-error" *ngIf="grabAmountError">
          <mat-icon style="font-size:14px;vertical-align:middle;">error_outline</mat-icon>
          {{ grabAmountError }}
        </small>

        <label class="grab-label mt">Notes <span class="muted">(optional)</span></label>
        <input
          type="text"
          class="grab-input"
          [(ngModel)]="grabNotes"
          placeholder="e.g. Birthday gift, quarterly bonus…"
        />
      </div>

      <div class="grab-terms">
        <mat-icon>info_outline</mat-icon>
        <span>{{ grabDialogOffer?.terms }}</span>
      </div>

      <div class="grab-actions">
        <button class="grab-cancel-btn" type="button" (click)="closeGrabDialog()">Cancel</button>
        <button
          class="grab-confirm-btn"
          type="button"
          [disabled]="!grabAmount || isProcessingGrab || !!grabAmountError"
          (click)="confirmPurchase()"
        >
          <span *ngIf="!isProcessingGrab">Confirm Purchase</span>
          <span *ngIf="isProcessingGrab" class="grab-spinner">Processing…</span>
        </button>
      </div>
    </ng-container>

    <!-- CHECKOUT / SUCCESS SCREEN -->
    <ng-container *ngIf="grabDialogStep === 'checkout'">
      <div class="grab-success-screen">
        <div class="grab-success-icon">
          <mat-icon>check_circle</mat-icon>
        </div>
        <h4>Voucher Claimed!</h4>
        <p>{{ grabResult?.message }}</p>

        <div class="grab-receipt">
          <div class="receipt-row">
            <span>Brand</span>
            <strong>{{ grabDialogOffer?.brand }}</strong>
          </div>
          <div class="receipt-row">
            <span>Amount Paid</span>
            <strong>₹{{ grabResult?.amount }}</strong>
          </div>
          <div class="receipt-row">
            <span>Reference No.</span>
            <strong class="ref-code">{{ grabResult?.refNo }}</strong>
          </div>
        </div>

        <div class="grab-ref-copy">
          <code>{{ grabResult?.refNo }}</code>
          <button class="grab-copy-btn" type="button" (click)="copyCode(grabResult?.refNo)">
            <mat-icon>content_copy</mat-icon> Copy
          </button>
        </div>

        <p class="grab-redeem-hint">
          <mat-icon>storefront</mat-icon> Use this reference at
          <a [href]="grabDialogOffer?.redemptionUrl" target="_blank" *ngIf="grabDialogOffer?.redemptionUrl">
            {{ grabDialogOffer?.brand }} website
          </a>
          <span *ngIf="!grabDialogOffer?.redemptionUrl">the brand website</span>
          to redeem your voucher.
        </p>

        <button class="grab-confirm-btn full-w" type="button" (click)="closeGrabDialog()">
          Done
        </button>
      </div>
    </ng-container>

  </div>
</div>

