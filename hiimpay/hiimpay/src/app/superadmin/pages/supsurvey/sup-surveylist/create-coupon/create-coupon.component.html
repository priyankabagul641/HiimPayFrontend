<div class="create-coupon-dialog">

  <h2 class="title">Create Coupon</h2>
  <p class="subtitle">Choose your preferred method to add coupons</p>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab" [class.active]="activeTab === 'manual'" (click)="switchTab('manual')">
      Manual Entry
    </button>
    <!-- <button class="tab" [class.active]="activeTab === 'excel'" (click)="switchTab('excel')">
      Excel Upload
    </button> -->
    <button class="tab" [class.active]="activeTab === 'api'" (click)="switchTab('api')">
      API Integration
    </button>
  </div>

  <!-- MANUAL -->
  <form *ngIf="activeTab === 'manual'"
        [formGroup]="couponForm"
        (ngSubmit)="submit()">

    <section class="section">
      <h4>Brand &amp; Category</h4>

      <div class="row">
        <div class="col">
          <label>Brand <span class="text-danger">*</span></label>
          <select formControlName="brandId" class="form-control"
                  [class.is-invalid]="couponForm.get('brandId')?.invalid && couponForm.get('brandId')?.touched">
            <option [ngValue]="null" disabled>Select brand</option>
            <option *ngFor="let b of brands" [ngValue]="b.id">{{ b.brandName }}</option>
          </select>
          <div class="invalid-feedback">Brand is required.</div>
        </div>

        <div class="col">
          <label>Category <span class="text-danger">*</span></label>
          <select formControlName="categoryId" class="form-control"
                  [class.is-invalid]="couponForm.get('categoryId')?.invalid && couponForm.get('categoryId')?.touched">
            <option [ngValue]="null" disabled>Select category</option>
            <option *ngFor="let cat of categoriesList" [ngValue]="cat.id">{{ cat.categoryName }}</option>
          </select>
          <div class="invalid-feedback">Category is required.</div>
        </div>
      </div>
    </section>

    <section class="section">
      <h4>Coupon Details</h4>

      <div class="row">
        <div class="col">
          <label>Product Name <span class="text-danger">*</span></label>
          <input formControlName="productName" class="form-control"
                 placeholder="e.g. Amazon 50% Discount"
                 [class.is-invalid]="couponForm.get('productName')?.invalid && couponForm.get('productName')?.touched">
          <div class="invalid-feedback">Product name is required.</div>
        </div>

        <div class="col">
          <label>Coupon Code <span class="text-danger">*</span></label>
          <div class="d-flex">
            <input formControlName="couponCode"
                   class="form-control"
                   [readonly]="!manualCode"
                   [class.is-invalid]="couponForm.get('couponCode')?.invalid && couponForm.get('couponCode')?.touched"
                   placeholder="Auto-generated">
            <button type="button" class="btn btn-outline-secondary ms-2" (click)="generateCode()">Generate</button>
            <button type="button" class="btn btn-link ms-2" (click)="toggleManual()">{{ manualCode ? 'Auto' : 'Manual' }}</button>
          </div>
          <div class="invalid-feedback d-block"
               *ngIf="couponForm.get('couponCode')?.invalid && couponForm.get('couponCode')?.touched">
            Coupon code is required.
          </div>
        </div>
      </div>

      <div class="row mt-2">
        <div class="col">
          <label>Provider Name</label>
          <input formControlName="providerName" class="form-control" placeholder="e.g. Amazon API">
        </div>

        <div class="col">
          <label>Serial No</label>
          <input type="number" formControlName="serialNo" class="form-control" placeholder="e.g. 20001">
        </div>
      </div>

      <div class="row mt-2">
        <div class="col">
          <label>Redemption Type <span class="text-danger">*</span></label>
          <select formControlName="redemptionType" class="form-control">
            <option value="ONLINE">ONLINE</option>
            <option value="OFFLINE">OFFLINE</option>
          </select>
        </div>
      </div>

      <div class="row mt-2">
        <div class="col">
          <label>Discount % <span class="text-danger">*</span></label>
          <input type="number" formControlName="discountPercent" class="form-control" min="0" max="100"
                 [class.is-invalid]="couponForm.get('discountPercent')?.invalid && couponForm.get('discountPercent')?.touched">
          <div class="invalid-feedback">Discount % (0â€“100) is required.</div>
        </div>

        <div class="col">
          <label>Min Value</label>
          <input type="number" formControlName="minValue" class="form-control" min="0" placeholder="0">
        </div>

        <div class="col">
          <label>Max Value</label>
          <input type="number" formControlName="maxValue" class="form-control" min="0" placeholder="0">
        </div>
      </div>

      <div class="row mt-2">
        <div class="col">
          <label>Denominations</label>
          <input formControlName="denominations" class="form-control" placeholder="e.g. 100,500,1000">
        </div>

        <div class="col">
          <label>Currency Code</label>
          <input formControlName="currencyCode" class="form-control" placeholder="INR">
        </div>

        <div class="col">
          <label>Country Code</label>
          <input formControlName="countryCode" class="form-control" placeholder="IN">
        </div>
      </div>

      <div class="row mt-2">
        <div class="col">
          <label>Description</label>
          <textarea formControlName="description" class="form-control" rows="2" placeholder="Short description"></textarea>
        </div>

        <div class="col">
          <label>Image URL</label>
          <input formControlName="imageUrl" class="form-control" placeholder="https://example.com/image.png">
        </div>
      </div>
    </section>

    <section class="section">
      <h4>Validity</h4>

      <div class="row">
        <div class="col">
          <label>Expiry Date <span class="text-danger">*</span></label>
          <input type="date" formControlName="expiryDate" class="form-control"
                 [min]="today"
                 [class.is-invalid]="couponForm.get('expiryDate')?.invalid && couponForm.get('expiryDate')?.touched">
          <div class="invalid-feedback">Expiry date is required and cannot be in the past.</div>
        </div>
      </div>
    </section>

    <div class="actions">
      <button type="button" class="btn btn-secondary" (click)="cancel()">Cancel</button>
      <button type="submit" class="btn btn-primary" [disabled]="couponForm.invalid">
        {{ title }}
      </button>
    </div>
  </form>

  <!-- EXCEL -->
  <div *ngIf="activeTab === 'excel'" class="tab-content">

    <div class="excel-card">
      <label class="label">Download Template</label>
      <a class="template-link" href="assets/coupon-template.xlsx" download>
        coupon-template.xlsx
      </a>

      <div class="upload-box" (click)="fileInput.click()">
        <input type="file"
               #fileInput
               hidden
               accept=".xlsx,.xls"
               (change)="onExcelSelect($event)">
        <div class="upload-icon">Upload</div>
        <div class="upload-text">Drag and drop file here</div>
        <div class="upload-subtext">or click to browse</div>
      </div>
    </div>

    <div class="actions">
      <button class="btn btn-secondary" (click)="cancel()">Cancel</button>
      <button class="btn btn-primary">Upload Excel</button>
    </div>

  </div>

  <!-- API -->
  <div *ngIf="activeTab === 'api'" class="tab-content">

    <div class="api-box">
      <h4>API Integration</h4>
      <p>Select a provider to auto-fill endpoint configuration, then save to sync coupons.</p>
    </div>

    <label>API Provider</label>
    <select [ngModel]="selectedProviderName" (ngModelChange)="onProviderChange($event)" class="form-control">
      <option value="" disabled>Select provider</option>
      <option *ngFor="let p of providerNames" [ngValue]="p">{{ p }}</option>
    </select>
    <small class="hint" *ngIf="!providerNames.length">Loading providers...</small>

    <div class="api-endpoint-card" *ngFor="let endpoint of apiEndpoints; let i = index">
      <div class="api-endpoint-header">
        <strong>{{ endpoint.endpointType || 'Endpoint' }}</strong>
        <button type="button" class="btn btn-outline-secondary btn-sm" (click)="removeEndpoint(i)">Remove</button>
      </div>

      <div class="row">
        <div class="col">
          <label>Endpoint Type</label>
          <input type="text" class="form-control" [(ngModel)]="endpoint.endpointType" placeholder="e.g. ISSUE_VOUCHER">
        </div>
        <div class="col">
          <label>Endpoint Name</label>
          <input type="text" class="form-control" [(ngModel)]="endpoint.name">
        </div>
      </div>

      <div class="row mt-2">
        <div class="col">
          <label>Method</label>
          <select class="form-control" [(ngModel)]="endpoint.method">
            <option value="GET">GET</option>
            <option value="POST">POST</option>
          </select>
        </div>
        <div class="col">
          <label>URL</label>
          <input type="text" class="form-control" [(ngModel)]="endpoint.url" placeholder="https://api.example.com/endpoint">
        </div>
      </div>

      <div class="row mt-2">
        <div class="col">
          <label>API Key</label>
          <input type="text" class="form-control" [(ngModel)]="endpoint.apiKey">
        </div>
        <div class="col">
          <label>Request Secret</label>
          <input type="text" class="form-control" [(ngModel)]="endpoint.requestSecret">
        </div>
      </div>
    </div>

    <small class="hint" *ngIf="pullMessage">{{ pullMessage }}</small>

    <div class="actions">
      <button class="btn btn-secondary" (click)="cancel()">Cancel</button>
      <button class="btn btn-primary" [disabled]="isSaving || !selectedProviderName" (click)="saveApiSetup()">
        {{ isSaving ? 'Saving...' : 'Save' }}
      </button>
    </div>

  </div>

</div>
